#!/bin/bash

main () {
    case ${1:-} in
        list-sinks) shift; listSinks "$@" ;;
        x-set-default-sink) xSetDefaultSink ;;
        get-volume) getVolume ;;
        increase-volume) shift; increaseVolume "$@" ;;
        decrease-volume) shift; decreaseVolume "$@" ;;
        list-x-options) listXOptions ;;
        show) listXOptions | rofimenu ;;
        *) exit 1 ;;
    esac
}

listSinks () {
    pactl list short sinks | awk '{print $2}'
}

getVolume () {
    if [ $(command -v wpctl) ]; then
        wpctl get-volume @DEFAULT_AUDIO_SINK@ | cut -c 11-
    else
        amixer sget Master | sed -E 's/.*\[([0-9]{0,3})%\].*/\1/p;d' | head -n 1
    fi
}

increaseVolume () {
    if [ $(command -v wpctl) ]; then
        wpctl set-volume @DEFAULT_AUDIO_SINK@ 0.$(printf "%02d" "${1:-5}")+
    else
        amixer sset Master "${1:-5}%+"
    fi
}

decreaseVolume () {
    if [ $(command -v wpctl) ]; then
        wpctl set-volume @DEFAULT_AUDIO_SINK@ 0.$(printf "%02d" "${1:-5}")-
    else
        amixer sset Master "${1:-5}%-"
    fi
}

xSetDefaultSink () {
    sink=$(audioctl list-sinks | rofi -dmenu -p 'select sink') && pactl set-default-sink "$sink"
}

listXOptions () {
    cat <<EOF
{
    "prompt": "option",
    "commands": [
        {
            "description": "Set default sink",
            "command": "audioctl x-set-default-sink"
        },
        {
            "description": "Increase volume",
            "command": "audioctl increase-volume"
        },
        {
            "description": "Decrease volume",
            "command": "audioctl decrease-volume"
        }
    ]
}
EOF
}

main "$@"
